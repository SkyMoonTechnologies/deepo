services:
  web:
    image: 'ghcr.io/skymoontechnologies/deepo:main'
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: '3000'
      NEXT_PUBLIC_APP_NAME: '${NEXT_PUBLIC_APP_NAME:-Deepo}'
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: '${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY:-}'
      CLERK_SECRET_KEY: '${CLERK_SECRET_KEY:-}'
      CLERK_WEBHOOK_SECRET: '${CLERK_WEBHOOK_SECRET:-}'
      NEXT_PUBLIC_GOATCOUNTER_URL: '${NEXT_PUBLIC_GOATCOUNTER_URL:-}'
    healthcheck:
      test:
        - CMD-SHELL
        - 'bun -e "fetch(''http://127.0.0.1:3000/api/health'').then((r) => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"'
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    labels:
      - traefik.enable=true
      - traefik.http.routers.deepo.rule=Host(`${DOMAIN_NAME}`)
      - traefik.http.routers.deepo.entrypoints=https
      - traefik.http.routers.deepo.tls=true
      - traefik.http.services.deepo.loadbalancer.server.port=3000
